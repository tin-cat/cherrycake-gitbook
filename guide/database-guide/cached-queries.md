# Cached queries

Cached queries allow you to dramatically improve performance in certain situations by preventing the database server from repeatedly performing the same query, storing the results in cache instead.

To perform a basic query with cache, use the [DatabaseProvider::queryCache](../../reference/core-classes/databaseprovider/databaseprovider-methods.md#querycache) method, this is how it would look:

```php
$result = $e->Database->main->queryCache(
    "select * from users order by rand()",
    \Cherrycake\CACHE_TTL_1_MINUTE
);
```

When iterating over the results like we did in the [Basic queries](basic-queries.md) section, you would get something like this:

```php
Douglas Engelbart
John Horton Conway
Frank Abagnale
Carl Sagan
Richard Feynmann
```

Note here that, even though the results have been randomly ordered thanks to the  `by rand()` clause in the SQL statement, we get the results in the same order if we execute the query multiple times. This is because the results were stored in the cache, and the query is not actually running, we're just getting the same results the cache system got in the first run.

> Because the cached results will expire after 1 minute because we set the TTL to `CACHE_TTL_1_MINUTE`, the result order will change if we execute the query when a minute has passed from the first execution.

## Cache key naming

Each object stored in cache has its own unique identifier key. When you run a cached query without specifying any [`cacheKeyNamingOptions`](../../reference/core-classes/databaseprovider/databaseprovider-methods.md#querycache) parameter like we did above, the cache key is automatically generated by creating a unique hash from the SQL statement itself.

For example, when executing the cached query in the example above:`select * from users order by rand()`, a unique key was generated automatically that looked like this:

```php
CherrycakeApp_Database_64df95723d106ba80b0cf725bc56ddd1
```

> When letting Database generate automatically the cache keys, different keys are generated even if a single character of the SQL statement has changed.

This means that you can trust a different cache key will be generated for each different query you perform, so in most simple queries you don't need to care about cache key collisions.

But in certain situations you'll need to cache different queries under the same cache key to get the maximum benefits of using a cached database system. For example, when you're retrieving data from the database relative to the current date and time.

Imagine you want to query all the users that have signed up to your web app during the last 24 hours, and that you want that query to be cached. You could do that like this:

```php
$timestamp24HoursEarlier = time() - (24 * 60 * 60);
$result = $e->Database->main->queryCache(
    "select * from users where dateSignUp >= '".date("Y-n-j H:i:s", $timestamp24HoursEarlier)."'",
    \Cherrycake\CACHE_TTL_1_HOUR
);
```

Can you see the problem there? We want the query to be cached for an hour and we haven't specified the [`cacheKeyNamingOptions`](../../reference/core-classes/databaseprovider/databaseprovider-methods.md#querycache) parameter, so the unique cache key for this query will be automatically generated using the SQL statement.

the problem is that, because we're basing our query on a value that changes every second, the SQL statement itself also changes every second, thus generating a different cache key almost every time the cached query is executed.

> This will cause our cache memory to fill with useless objects, and will cause the query to be executed at least once per second.

To solve this kind of situations, we specify our own cache key instead of letting Database create its own automatically. We do this by passing the [`cacheKeyNamingOptions`](../../reference/core-classes/databaseprovider/databaseprovider-methods.md#querycache) parameter to [DatabaseProvider::queryCache](../../reference/core-classes/databaseprovider/databaseprovider-methods.md#querycache), like this:

```php
$timestamp24HoursEarlier = time() - (24 * 60 * 60);
$result = $e->Database->main->queryCache(
    "select * from users where dateSignUp >= '".date("Y-n-j H:i:s", $timestamp24HoursEarlier)."'",
    \Cherrycake\CACHE_TTL_1_HOUR,
    [
    ]
);
```

